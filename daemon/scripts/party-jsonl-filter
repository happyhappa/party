#!/usr/bin/env python3
"""Filter Claude hook JSONL to concise USER/ASSISTANT text blocks."""

from __future__ import annotations

import json
import os
import sys
from typing import Any

MAX_MESSAGE_CHARS = int(os.environ.get('PARTY_BRIEF_MAX_MSG_CHARS', 3000))
MIN_MESSAGE_CHARS = int(os.environ.get('PARTY_BRIEF_MIN_MSG_CHARS', 20))
MAX_OUTPUT_BYTES = int(os.environ.get('PARTY_BRIEF_MAX_OUTPUT_KB', 50)) * 1024


def extract_text(content: Any) -> str:
    if isinstance(content, str):
        return content
    if isinstance(content, list):
        parts: list[str] = []
        for block in content:
            if not isinstance(block, dict):
                continue
            if block.get("type") != "text":
                continue
            text = block.get("text")
            if isinstance(text, str):
                parts.append(text)
        return "\n".join(parts)
    return ""


def truncate_message(text: str) -> str:
    if len(text) <= MAX_MESSAGE_CHARS:
        return text
    return text[:MAX_MESSAGE_CHARS] + "... [truncated]"


def role_header(record_type: str) -> str:
    return "=== USER ===" if record_type == "user" else "=== ASSISTANT ==="


def trim_output_tail(text: str) -> str:
    raw = text.encode("utf-8")
    if len(raw) <= MAX_OUTPUT_BYTES:
        return text
    return raw[-MAX_OUTPUT_BYTES:].decode("utf-8", errors="ignore")


def process(lines: list[str]) -> str:
    out: list[str] = []

    for line in lines:
        line = line.strip()
        if not line:
            continue

        try:
            record = json.loads(line)
        except json.JSONDecodeError:
            continue

        rec_type = record.get("type")
        if rec_type not in {"user", "assistant"}:
            continue

        message = record.get("message")
        content = None
        if isinstance(message, dict):
            content = message.get("content")
        if content is None:
            content = record.get("content")

        text = extract_text(content).strip()
        if not text:
            continue

        text = truncate_message(text).strip()
        if len(text) < MIN_MESSAGE_CHARS:
            continue

        out.append(f"{role_header(rec_type)}\n{text}\n")

    return trim_output_tail("\n".join(out))


def main() -> int:
    lines = sys.stdin.read().splitlines()
    result = process(lines)
    if result:
        sys.stdout.write(result)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
