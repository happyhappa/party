#!/usr/bin/env bash
#
# party-v2 - Creates 3-tier tmux layout for LLM orchestration
#
# Layout:
# ┌────────────┬────────────────────┐
# │            │        CC (50%)    │
# │     OC     ├────────────────────┤
# │            │        CX (50%)    │
# └────────────┴────────────────────┘
#
# Usage: party [session-name]
#
# Configuration (optional ~/.config/relay/party.conf):
#   RELAY_OC_DIR, RELAY_CC_DIR, RELAY_CX_DIR - working directories
#   RELAY_OC_CMD, RELAY_CC_CMD, RELAY_CX_CMD - launch commands
#
# Defaults:
#   OC: continues (-c) in parent of $PWD
#   CC: fresh session in $PWD
#   CX: fresh codex in $PWD
#

set -euo pipefail

SESSION="${1:-party}"
LLM_SHARE="$HOME/llm-share"
CONFIG_FILE="$HOME/.config/relay/party.conf"

# Source optional config
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# Per-pane working directories (defaults: OC=parent, CC/CX=current)
OC_DIR="${RELAY_OC_DIR:-$(dirname "$PWD")}"
CC_DIR="${RELAY_CC_DIR:-$PWD}"
CX_DIR="${RELAY_CX_DIR:-$PWD}"

# Per-agent launch commands (with AGENT_ROLE set)
OC_CMD="${RELAY_OC_CMD:-claude -c --dangerously-skip-permissions}"
CC_CMD="${RELAY_CC_CMD:-claude --dangerously-skip-permissions}"
CX_CMD="${RELAY_CX_CMD:-codex -a never -s workspace-write --add-dir /tmp --add-dir ~/llm-share --add-dir ~/.cache}"

RELAY_LOG="$LLM_SHARE/relay/log/events.jsonl"

# Colors for status
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[party-v2]${NC} $1"
}

err() {
    echo -e "${RED}[party-v2]${NC} $1" >&2
}

# Check if session already exists
if tmux has-session -t "$SESSION" 2>/dev/null; then
    log "Session '$SESSION' already exists. Attaching..."
    exec tmux attach -t "$SESSION"
fi

# Ensure relay log file exists for tail
mkdir -p "$(dirname "$RELAY_LOG")"
touch "$RELAY_LOG"

log "Creating session '$SESSION' with 3-tier layout..."

# Create session with OC pane (left side)
tmux new-session -d -s "$SESSION" -n main -c "$OC_DIR"

# Split right side (60% width for right column)
tmux split-window -h -l 60% -t "$SESSION:main.0" -c "$CC_DIR"

# Split right column into 2 rows: CC (50%), CX (50%)
tmux split-window -v -l 50% -t "$SESSION:main.1" -c "$CX_DIR"

# Name panes using select-pane -T (tmux 2.6+)
tmux select-pane -t "$SESSION:main.0" -T "OC"
tmux select-pane -t "$SESSION:main.1" -T "CC"
tmux select-pane -t "$SESSION:main.2" -T "CX"

# Set pane border format to show titles (tmux 2.6+)
tmux set-option -t "$SESSION" pane-border-status top
tmux set-option -t "$SESSION" pane-border-format " #{pane_title} "

# Select OC pane as default
tmux select-pane -t "$SESSION:main.0"

log "Layout created. Pane IDs:"
tmux list-panes -t "$SESSION:main" -F "  #{pane_index}: #{pane_title} (#{pane_id})"

# Write pane map for relay daemon (agent name -> pane_id, fixed mapping)
# Uses pane index, not title (Claude Code CLI overwrites titles)
PANE_MAP="$LLM_SHARE/relay/state/panes.json"
log "Writing pane map to $PANE_MAP"
OC_PANE=$(tmux display-message -p -t "$SESSION:main.0" '#{pane_id}')
CC_PANE=$(tmux display-message -p -t "$SESSION:main.1" '#{pane_id}')
CX_PANE=$(tmux display-message -p -t "$SESSION:main.2" '#{pane_id}')
printf '{"oc":"%s","cc":"%s","cx":"%s"}\n' "$OC_PANE" "$CC_PANE" "$CX_PANE" > "$PANE_MAP"

# Set @role pane option (backup identification method)
tmux set-option -p -t "$OC_PANE" @role oc
tmux set-option -p -t "$CC_PANE" @role cc
tmux set-option -p -t "$CX_PANE" @role cx

log ""
log "Launching agents with AGENT_ROLE set..."

# Launch agents with AGENT_ROLE environment variable
tmux send-keys -t "$SESSION:main.0" "export AGENT_ROLE=oc && $OC_CMD" Enter
tmux send-keys -t "$SESSION:main.1" "export AGENT_ROLE=cc && $CC_CMD" Enter
tmux send-keys -t "$SESSION:main.2" "export AGENT_ROLE=cx && $CX_CMD" Enter

log ""
log "Agents launched:"
log "  OC: $OC_CMD (in $OC_DIR)"
log "  CC: $CC_CMD (in $CC_DIR)"
log "  CX: $CX_CMD (in $CX_DIR)"
log ""

# Attach to session
exec tmux attach -t "$SESSION"
