#!/usr/bin/env bash
set -euo pipefail

# relay CLI wrapper - RMF v2 format
# Usage: relay send <oc|cc|cx|all> "message"

cmd="${1:-}"
if [[ "$cmd" != "send" ]]; then
  echo "Usage: relay send <oc|cc|cx|all> <message>" >&2
  exit 2
fi

shift

to="${1:-}"
shift || true

if [[ -z "$to" ]]; then
  echo "Missing recipient. Use oc|cc|cx|all" >&2
  exit 2
fi

case "$to" in
  oc|cc|cx|all) ;;
  *)
    echo "Invalid recipient: $to (use oc|cc|cx|all)" >&2
    exit 2
    ;;
esac

if [[ $# -lt 1 ]]; then
  echo "Missing message payload" >&2
  exit 2
fi

msg="$*"

# Determine sender from AGENT_ROLE env var (default: oc)
from="${AGENT_ROLE:-oc}"

# Outbox directory structure: outbox/<from>/
outbox_dir="/mnt/llm-share/relay/outbox/${from}"
mkdir -p "$outbox_dir"

# Generate filename: <timestamp>-<rand>.msg
timestamp=$(date +%Y%m%d_%H%M%S)
rand=$(head -c 4 /dev/urandom | xxd -p)
filename="${timestamp}-${rand}.msg"

# Write RMF v2 format: TO header, separator, body
cat > "${outbox_dir}/${filename}" << EOF
TO: ${to}
---
${msg}
EOF
