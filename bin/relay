#!/usr/bin/env bash
set -euo pipefail

# relay CLI wrapper - RMF v2 format
# Usage:
#   relay send <oc|cc|cx|admin|all> "message"
#   relay checkpoint <chk_id> "<content>" [--title <title>] [--labels <labels>]

# Shared: determine sender and write .msg file
_write_msg() {
  local to="$1" kind="$2" body="$3"
  local from="${AGENT_ROLE:-oc}"
  local outbox_dir="${HOME}/.local/share/relay/outbox/${from}"
  mkdir -p "$outbox_dir"

  local timestamp rand filename
  timestamp=$(date +%Y%m%d_%H%M%S)
  rand=$(head -c 4 /dev/urandom | xxd -p)
  filename="${timestamp}-${rand}.msg"

  cat > "${outbox_dir}/${filename}" << EOF
TO: ${to}
KIND: ${kind}
---
${body}
EOF
}

# relay send <oc|cc|cx|admin|all> "message"
_relay_send() {
  local to="${1:-}"
  shift || true

  if [[ -z "$to" ]]; then
    echo "Missing recipient. Use oc|cc|cx|admin|all" >&2
    exit 2
  fi

  case "$to" in
    oc|cc|cx|admin|all) ;;
    *)
      echo "Invalid recipient: $to (use oc|cc|cx|admin|all)" >&2
      exit 2
      ;;
  esac

  if [[ $# -lt 1 ]]; then
    echo "Missing message payload" >&2
    exit 2
  fi

  local msg="$*"
  _write_msg "$to" "chat" "$msg"
}

# relay checkpoint <chk_id> "<content>" [--title <title>] [--labels <labels>]
_relay_checkpoint() {
  local chk_id="${1:-}"
  local content="${2:-}"
  shift 2 || true

  if [[ -z "$chk_id" || -z "$content" ]]; then
    echo "Usage: relay checkpoint <chk_id> <content> [--title <title>] [--labels <labels>]" >&2
    exit 2
  fi

  local title="" labels_raw=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --title)
        if [[ $# -lt 2 ]]; then
          echo "Error: --title requires a value" >&2
          exit 2
        fi
        title="$2"
        shift 2
        ;;
      --labels)
        if [[ $# -lt 2 ]]; then
          echo "Error: --labels requires a value" >&2
          exit 2
        fi
        labels_raw="$2"
        shift 2
        ;;
      *)
        shift
        ;;
    esac
  done

  local from="${AGENT_ROLE:-oc}"

  # Build labels JSON object from comma-separated "key:value" pairs using python3
  local labels_json
  labels_json=$(python3 -c "
import json, sys
raw = sys.argv[1]
result = {}
if raw:
    for pair in raw.split(','):
        idx = pair.find(':')
        if idx > 0:
            result[pair[:idx]] = pair[idx+1:]
print(json.dumps(result))
" "$labels_raw")

  # Escape content for JSON: newlines, quotes, backslashes, tabs
  local json_content
  json_content=$(printf '%s' "$content" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))' 2>/dev/null) || {
    # Fallback: basic escaping if python3 unavailable
    json_content=$(printf '%s' "$content" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
    json_content="\"${json_content}\""
  }

  # Escape title for JSON
  local json_title
  json_title=$(printf '%s' "$title" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))' 2>/dev/null) || {
    json_title="\"${title//\"/\\\"}\""
  }

  # Build JSON payload matching CheckpointContent struct
  local payload
  payload=$(cat <<JSONEOF
{"chk_id":"${chk_id}","role":"${from}","content":${json_content},"title":${json_title},"labels":${labels_json}}
JSONEOF
)

  _write_msg "admin" "checkpoint_content" "$payload"
}

# --- main dispatch ---
cmd="${1:-}"
shift || true

case "$cmd" in
  send)
    _relay_send "$@"
    ;;
  checkpoint)
    _relay_checkpoint "$@"
    ;;
  *)
    echo "Usage: relay <send|checkpoint> ..." >&2
    echo "  relay send <oc|cc|cx|admin|all> <message>" >&2
    echo "  relay checkpoint <chk_id> <content> [--title <title>] [--labels <labels>]" >&2
    exit 2
    ;;
esac
